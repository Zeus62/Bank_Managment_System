{% extends 'dashboard/base.html' %}

{% block title %}Test Automation Dashboard{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h2>
        <i class="bi bi-speedometer2"></i> Test Automation Dashboard
    </h2>
    <p>Real-time test execution monitoring and analytics</p>
</div>

<!-- Summary Stats -->
<div class="row mb-5">
    <div class="col-md-3">
        <div class="card stat-card success">
            <div class="card-body text-center stat-card-content">
                <i class="bi bi-check-circle stat-icon" style="color: #10b981;"></i>
                <div class="stat-value" style="color: #10b981;">
                    {{ latest_run.passed if latest_run else 0 }}
                </div>
                <div class="stat-label">Tests Passed</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card danger">
            <div class="card-body text-center stat-card-content">
                <i class="bi bi-x-circle stat-icon" style="color: #ef4444;"></i>
                <div class="stat-value" style="color: #ef4444;">
                    {{ latest_run.failed if latest_run else 0 }}
                </div>
                <div class="stat-label">Tests Failed</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card info">
            <div class="card-body text-center stat-card-content">
                <i class="bi bi-percent stat-icon" style="color: #3b82f6;"></i>
                <div class="stat-value" style="color: #3b82f6;">
                    {% if latest_run %}{{ "%.1f"|format(latest_run.pass_rate) }}{% else %}0{% endif %}%
                </div>
                <div class="stat-label">Pass Rate</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card warning">
            <div class="card-body text-center stat-card-content">
                <i class="bi bi-file-code stat-icon" style="color: #f59e0b;"></i>
                <div class="stat-value" style="color: #f59e0b;">
                    {% if latest_run %}{{ "%.1f"|format(latest_run.coverage) }}{% else %}0{% endif %}%
                </div>
                <div class="stat-label">Code Coverage</div>
            </div>
        </div>
    </div>
</div>

<!-- Latest Run Info -->
{% if latest_run %}
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 style="margin: 0;"><i class="bi bi-play-circle"></i> Latest Test Run</h5>
                </div>
                <span class="status-badge status-{{ 'passed' if latest_run.failed == 0 else 'failed' }}">
                    {{ 'PASSED' if latest_run.failed == 0 else 'FAILED' }}
                </span>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div>
                            <small style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: #f1f5f9;">Run ID</small>
                            <p style="margin: 0.5rem 0 0 0; color: #f1f5f9;"><code style="color: #f1f5f9;">{{ latest_run.run_id[:20] }}...</code></p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div>
                            <small style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: #f1f5f9;">Total Tests</small>
                            <p style="margin: 0.5rem 0 0 0; font-size: 1.3rem; font-weight: 600; color: #f1f5f9;">{{ latest_run.total_tests }}</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div>
                            <small style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: #f1f5f9;">Duration</small>
                            <p style="margin: 0.5rem 0 0 0; font-size: 1.3rem; font-weight: 600; color: #f1f5f9;">{{ "%.2f"|format(latest_run.duration) }}s</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div>
                            <small style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: #f1f5f9;">Timestamp</small>
                            <p style="margin: 0.5rem 0 0 0; color: #f1f5f9;">{{ latest_run.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Test Results Cards -->
                <div class="row mt-4 mb-4">
                    <div class="col-md-3">
                        <div style="padding: 1rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3); text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: 700; color: #10b981;">{{ latest_run.passed }}</div>
                            <small style="font-size: 0.85rem; color: #f1f5f9;">Passed</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div style="padding: 1rem; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05)); border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3); text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: 700; color: #ef4444;">{{ latest_run.failed }}</div>
                            <small style="font-size: 0.85rem; color: #f1f5f9;">Failed</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div style="padding: 1rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05)); border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.3); text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: 700; color: #f59e0b;">{{ latest_run.skipped }}</div>
                            <small style="font-size: 0.85rem; color: #f1f5f9;">Skipped</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div style="padding: 1rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05)); border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3); text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: 700; color: #6366f1;">{{ latest_run.pass_rate }}%</div>
                            <small style="font-size: 0.85rem; color: #f1f5f9;">Pass Rate</small>
                        </div>
                    </div>
                </div>
                
                <div style="border-top: 1px solid var(--border-color); margin-top: 0; padding-top: 1.5rem;">
                    <a href="{{ url_for('run_details', run_id=latest_run.id) }}" class="btn btn-primary">
                        <i class="bi bi-arrow-right"></i> View Detailed Report
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row mb-5">
    <!-- Pass Rate Trend Chart -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 style="margin: 0;"><i class="bi bi-graph-up-arrow"></i> Pass Rate Trend</h5>
                <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">Last 30 days performance</small>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent Failures -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 style="margin: 0;"><i class="bi bi-exclamation-triangle"></i> Recent Failures</h5>
                    <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">Latest failed tests</small>
                </div>
                <a href="{{ url_for('failures') }}" class="btn btn-sm btn-outline-primary" style="font-size: 0.75rem;">View All</a>
            </div>
            <div class="card-body" style="max-height: 450px; overflow-y: auto;">
                {% if recent_failures %}
                    {% for failure in recent_failures %}
                    <div class="failure-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <strong style="word-break: break-word; color: #f1f5f9;">{{ failure.test_name.split('::')[-1][:40] }}</strong>
                                <small class="text-muted d-block" style="margin-top: 0.25rem; font-size: 0.8rem;">{{ failure.test_file.split('/')[-1] }}</small>
                            </div>
                            <small class="text-muted" style="white-space: nowrap; margin-left: 0.5rem;">{{ "%.2f"|format(failure.duration) }}s</small>
                        </div>
                        {% if failure.error_message %}
                        <div class="error-message mt-2" style="font-size: 0.8rem; max-height: 100px;">
                            {{ failure.error_message[:150] }}{% if failure.error_message|length > 150 %}...{% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-check-circle" style="font-size: 3rem; color: #10b981; opacity: 0.7;"></i>
                        <p class="mt-3" style="color: var(--text-muted);">No recent failures!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Test Distribution & Duration -->
<div class="row mb-5">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 style="margin: 0;"><i class="bi bi-pie-chart"></i> Test Distribution</h5>
                <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">Current run breakdown</small>
            </div>
            <div class="card-body">
                <canvas id="distributionChart" height="90"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 style="margin: 0;"><i class="bi bi-bar-chart"></i> Results Over Time</h5>
                <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">Passed vs Failed tests</small>
            </div>
            <div class="card-body">
                <canvas id="resultsChart" height="90"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Footer -->
<div class="row mb-5">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body py-4">
                <div style="font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, var(--primary-light), var(--primary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    {{ total_runs }}
                </div>
                <p style="margin: 0.5rem 0 0 0; color: #f1f5f9;">Total Test Runs</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body py-4">
                <div style="font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #10b981, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    {{ avg_pass_rate }}%
                </div>
                <p style="margin: 0.5rem 0 0 0; color: #f1f5f9;">Avg Pass Rate</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body py-4">
                <div style="font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #3b82f6, #2563eb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    {{ latest_run.total_tests if latest_run else 0 }}
                </div>
                <p style="margin: 0.5rem 0 0 0; color: #f1f5f9;">Test Cases</p>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<div id="chart-data" style="display: none;"
     data-labels='[{% for run in recent_runs %}"{{ run.start_time.strftime("%m/%d %H:%M") }}"{% if not loop.last %},{% endif %}{% endfor %}]'
     data-passed='[{% for run in recent_runs %}{{ run.passed }}{% if not loop.last %},{% endif %}{% endfor %}]'
     data-failed='[{% for run in recent_runs %}{{ run.failed }}{% if not loop.last %},{% endif %}{% endfor %}]'
     data-pass-rate='[{% for run in recent_runs %}{{ run.pass_rate }}{% if not loop.last %},{% endif %}{% endfor %}]'
     data-latest-passed='{{ latest_run.passed if latest_run else 0 }}'
     data-latest-failed='{{ latest_run.failed if latest_run else 0 }}'
     data-latest-skipped='{{ latest_run.skipped if latest_run else 0 }}'>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get data from hidden element
    const chartDataElement = document.getElementById('chart-data');
    
    const trendData = {
        labels: JSON.parse(chartDataElement.getAttribute('data-labels') || '[]'),
        passed: JSON.parse(chartDataElement.getAttribute('data-passed') || '[]'),
        failed: JSON.parse(chartDataElement.getAttribute('data-failed') || '[]'),
        passRate: JSON.parse(chartDataElement.getAttribute('data-pass-rate') || '[]')
    };
    
    const latestPassed = parseInt(chartDataElement.getAttribute('data-latest-passed') || '0');
    const latestFailed = parseInt(chartDataElement.getAttribute('data-latest-failed') || '0');
    const latestSkipped = parseInt(chartDataElement.getAttribute('data-latest-skipped') || '0');
    
    // Pass Rate Trend Chart
    if (document.getElementById('trendChart')) {
        new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: {
                labels: trendData.labels,
                datasets: [{
                    label: 'Pass Rate %',
                    data: trendData.passRate,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        labels: { color: '#e2e8f0' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: '#94a3b8' },
                        grid: { color: '#334155' }
                    },
                    x: {
                        ticks: { color: '#94a3b8' },
                        grid: { color: '#334155' }
                    }
                }
            }
        });
    }
    
    // Distribution Chart
    if (document.getElementById('distributionChart')) {
        new Chart(document.getElementById('distributionChart'), {
            type: 'doughnut',
            data: {
                labels: ['Passed', 'Failed', 'Skipped'],
                datasets: [{
                    data: [latestPassed, latestFailed, latestSkipped],
                    backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#e2e8f0' }
                    }
                }
            }
        });
    }
    
    // Duration Chart (Passed vs Failed over time)
    if (document.getElementById('durationChart')) {
        new Chart(document.getElementById('durationChart'), {
            type: 'bar',
            data: {
                labels: trendData.labels,
                datasets: [{
                    label: 'Passed',
                    data: trendData.passed,
                    backgroundColor: '#22c55e'
                }, {
                    label: 'Failed',
                    data: trendData.failed,
                    backgroundColor: '#ef4444'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        labels: { color: '#e2e8f0' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: true,
                        ticks: { color: '#94a3b8' },
                        grid: { color: '#334155' }
                    },
                    x: {
                        stacked: true,
                        ticks: { color: '#94a3b8' },
                        grid: { color: '#334155' }
                    }
                }
            }
        });
    }
</script>
{% endblock %}